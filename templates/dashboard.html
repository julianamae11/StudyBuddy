<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | StudyBuddy</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dasboard.css') }}">
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="nav-brand">
            <img src="{{ url_for('static', filename='css/images/sb.png') }}" alt="Study Buddy Logo" class="logo">
            <span class="brand-text">STUDY BUDDY</span>
        </div>
        <button class="logout-btn" onclick="window.location.href='{{ url_for('logout') }}'">Logout</button>
    </nav>

    <div class="container">
        <!-- Dashboard Header -->
        <div class="dashboard-header">
            <div class="header-left">
                <h1>STUDY BUDDY DASHBOARD</h1>
                <p class="welcome-text">WELCOME BACK! USER: <span class="username">{{ username|upper }}</span></p>
            </div>
            <div class="header-right">
                <div class="time-label">PHILIPPINE STANDARD TIME (PST)</div>
                <div id="ph-time" class="time-value">Loading...</div>
            </div>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card">
                <h3 class="stat-title">TOTAL TOPICS</h3>
                <div class="stat-value">{{ summary.total_topics or 0 }}</div>
                <p class="stat-footer">Defined across all subjects</p>
            </div>
            
            <div class="stat-card">
                <h3 class="stat-title">COMPLETION RATE</h3>
                <div class="stat-value">{{ "%.1f" | format(summary.completion_percentage or 0.0) }}%</div>
                <p class="stat-footer">{{ summary.completed_topics or 0 }}/{{ summary.total_topics or 0 }} Done</p>
            </div>
            
            <div class="stat-card">
                <h3 class="stat-title">TIME REMAINING</h3>
                <div class="stat-value">
                    {% set completed_time = (summary.total_estimated_time * (summary.completion_percentage / 100)) if summary.total_estimated_time and summary.completion_percentage else 0.0 %}
                    {% set remaining_time = summary.total_estimated_time - completed_time %}
                    {{ "%.1f" | format(remaining_time) }} HRS
                </div>
                <p class="stat-footer">Estimated study time left</p>
            </div>
            
            <div class="stat-card">
                <h3 class="stat-title">AVG. DIFFICULTY</h3>
                <div class="stat-value">{{ "%.1f" | format(summary.avg_difficulty or 0.0) }}</div>
                <p class="stat-footer">Average rating of all topics (1-5)</p>
            </div>
        </div>
        
        <!-- Alarm Clock Section -->
        <div class="alarm-section">
            <h2 class="alarm-title">PST ALARM CLOCK</h2>
            <div class="alarm-controls">
                <div class="time-display">
                    <span id="alarm-display-time">--:--</span>
                    <span class="time-indicator">‚è∞</span>
                </div>
                <div class="alarm-buttons">
                    <button class="btn-set" onclick="setAlarm()">Set Alarm</button>
                    <button class="btn-clear" onclick="clearAlarm()">Clear Alarm</button>
                </div>
                <div id="alarm-status" class="alarm-status">No Alarm Set</div>
            </div>
            <input type="time" id="alarm-time-input" style="display:none;">
        </div>

        <!-- Quick Actions -->
        <div class="quick-actions">
            <h3 class="quick-actions-title">QUICK ACTIONS</h3>
            <div class="action-buttons">
                <a href="{{ url_for('schedule') }}" class="action-btn">View Today's Schedule</a>
                <a href="{{ url_for('view_subjects') }}" class="action-btn">Manage Subjects & Topics</a>
                <a href="{{ url_for('add_subject_topic') }}" class="action-btn">Add New Subject/Topic</a>
                <a href="{{ url_for('charts') }}" class="action-btn">Charts</a>
            </div>
        </div>

        <audio id="alarm-sound" src="{{ url_for('static', filename='alarm.mp3') }}" preload="auto"></audio>
        <audio id="alarm-sound" src="{{ url_for('static', filename='alarm.mp3') }}" preload="auto"></audio>
    </div>

    <script>
        // Global variables for alarm state
        // let alarmTime = localStorage.getItem('dashboardAlarmTime') || null; // Handled by global modal now
        // let isAlarmTriggered = false; 
        let audioCtx;

        // Initialize alarm display from storage
        function updateDashboardAlarmUI() {
            const storedTime = localStorage.getItem('dashboardAlarmTime');
            if (storedTime) {
                document.getElementById('alarm-display-time').textContent = storedTime;
                document.getElementById('alarm-status').textContent = 'Alarm Set';
                document.getElementById('alarm-status').className = 'alarm-status active';
            } else {
                document.getElementById('alarm-display-time').textContent = '--:--';
                document.getElementById('alarm-status').textContent = 'No Alarm Set';
                document.getElementById('alarm-status').className = 'alarm-status';
            }
        }
        
        // Update UI on load
        updateDashboardAlarmUI();
        
        // Listen for storage changes (in case alarm is turned off from another tab/modal)
        window.addEventListener('storage', function(e) {
            if (e.key === 'dashboardAlarmTime') {
                updateDashboardAlarmUI();
            }
        });
        
        // Also poll for changes (since storage event doesn't fire on same page)
        setInterval(updateDashboardAlarmUI, 2000);

        // Ensure AudioContext is initialized on the first user interaction
        document.addEventListener('click', () => {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
        }, { once: true });

        // Audio Element and Alarm Check
        // const alarmSound = document.getElementById('alarm-sound'); // Removed to avoid conflict with global alarm
        // const triggeredAlarms = new Set();

        // function checkStudyAlarms() { ... } // Removed old logic
        
        // Melodic Alarm
        function playMelody() {
            if (!audioCtx) {
                console.error("AudioContext not running. Click anywhere on the page first.");
                return;
            }

            const now = audioCtx.currentTime;
            const oscillator = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioCtx.destination);
            
            gainNode.gain.setValueAtTime(0.5, now);
            oscillator.type = 'triangle';

            const notes = [
                { freq: 523.25, duration: 0.25 },
                { freq: 392.00, duration: 0.25 },
                { freq: 440.00, duration: 0.25 },
                { freq: 349.23, duration: 0.50 }
            ];
            
            let timeOffset = now;

            for (let i = 0; i < notes.length; i++) {
                const note = notes[i];
                const noteStart = timeOffset;
                const noteEnd = timeOffset + note.duration;

                oscillator.frequency.setValueAtTime(note.freq, noteStart);
                gainNode.gain.linearRampToValueAtTime(0.8, noteStart + 0.01);
                gainNode.gain.linearRampToValueAtTime(0.1, noteEnd - 0.05);
                gainNode.gain.linearRampToValueAtTime(0, noteEnd);

                timeOffset = noteEnd;
            }
            
            oscillator.start(now);
            oscillator.stop(timeOffset);
        }

        function playAlarmSound() {
            for (let i = 0; i < 3; i++) {
                setTimeout(playMelody, i * 1500);
            }
        }
        
        // Alarm Control Functions
        function setAlarm() {
            const inputElement = document.getElementById('alarm-time-input');
            inputElement.type = 'time';
            inputElement.style.display = 'block';
            inputElement.focus();
            
            inputElement.onchange = function() {
                const timeValue = inputElement.value;
                
                if (timeValue) {
                    localStorage.setItem('dashboardAlarmTime', timeValue); // Save to storage
                    updateDashboardAlarmUI();
                    inputElement.style.display = 'none';
                }
            };
        }

        function clearAlarm() {
            localStorage.removeItem('dashboardAlarmTime'); // Clear from storage
            updateDashboardAlarmUI();
            document.getElementById('alarm-time-input').style.display = 'none';
        }

        // Core Alarm Check Logic - REMOVED (Handled by global modal)
        function checkAlarm(currentTime24hr) {
            // Logic moved to alarm_modal.html
        }

        // Real-Time Clock Update
        function updatePhilippineTime() {
            const now = new Date();
            const phTimeElement = document.getElementById('ph-time');

            const displayFormatter = new Intl.DateTimeFormat('en-PH', {
                timeZone: 'Asia/Manila',
                weekday: 'short',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                day: 'numeric',
                month: 'short'
            });

            const comparisonFormatter = new Intl.DateTimeFormat('en-PH', {
                timeZone: 'Asia/Manila',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });

            const timeString = displayFormatter.format(now) + " PST";
            const currentTime24hr = comparisonFormatter.format(now);

            if (phTimeElement) {
                phTimeElement.textContent = timeString;
            }

            checkAlarm(currentTime24hr);
        }

        updatePhilippineTime();
        setInterval(updatePhilippineTime, 1000);

        // Study Reminder
        function showStudyReminder() {
            fetch("{{ url_for('get_study_reminder') }}")
                .then(response => response.text())
                .then(message => {
                    // alert(message); // Optional: Disable the alert if it's annoying
                })
                .catch(error => {
                    console.error('Error fetching study reminder:', error);
                });
        }

        window.onload = showStudyReminder;
    </script>
    
    <!-- Include Global Alarm Modal -->
    {% include 'includes/alarm_modal.html' %}
</body>
</html>
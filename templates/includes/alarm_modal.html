<!-- Alarm Modal Component -->
<div id="study-alarm-modal" class="alarm-modal-overlay" style="display: none;">
    <div class="alarm-modal-content">
        <div class="alarm-icon-wrapper">
            <span class="alarm-icon">‚è∞</span>
        </div>
        <h2 class="alarm-title">Time to Study!</h2>
        <div class="alarm-details">
            <p><strong>Subject:</strong> <span id="alarm-subject"></span></p>
            <p><strong>Topic:</strong> <span id="alarm-topic"></span></p>
            <p><strong>Time:</strong> <span id="alarm-time"></span></p>
        </div>
        <div class="alarm-actions">
            <button id="btn-snooze" class="btn-alarm btn-snooze">Snooze (5m)</button>
            <button id="btn-off" class="btn-alarm btn-off">Turn Off</button>
        </div>
    </div>
</div>

<!-- Alarm Sound -->
<audio id="global-alarm-sound" src="{{ url_for('static', filename='alarm.mp3') }}" preload="auto" loop></audio>

<style>
    /* Modal Styles */
    .alarm-modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        z-index: 9999;
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        animation: fadeIn 0.3s ease-out;
    }

    .alarm-modal-content {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        text-align: center;
        max-width: 400px;
        width: 90%;
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease-out;
        border: 2px solid #ff4757;
    }

    .alarm-icon-wrapper {
        font-size: 4rem;
        margin-bottom: 1rem;
        animation: ring 1s infinite;
    }

    .alarm-title {
        color: #2f3542;
        margin-bottom: 1.5rem;
        font-size: 1.8rem;
        font-weight: bold;
    }

    .alarm-details {
        background: #f1f2f6;
        padding: 1rem;
        border-radius: 10px;
        margin-bottom: 1.5rem;
        text-align: left;
    }

    .alarm-details p {
        margin: 0.5rem 0;
        color: #57606f;
        font-size: 1.1rem;
    }

    .alarm-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
    }

    .btn-alarm {
        padding: 0.8rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 1rem;
        cursor: pointer;
        transition: transform 0.1s;
        font-weight: bold;
    }

    .btn-alarm:active {
        transform: scale(0.95);
    }

    .btn-snooze {
        background-color: #ffa502;
        color: white;
    }

    .btn-off {
        background-color: #ff4757;
        color: white;
    }

    @keyframes ring {
        0% { transform: rotate(0); }
        10% { transform: rotate(10deg); }
        20% { transform: rotate(-10deg); }
        30% { transform: rotate(10deg); }
        40% { transform: rotate(-10deg); }
        50% { transform: rotate(0); }
        100% { transform: rotate(0); }
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @keyframes slideUp {
        from { transform: translateY(20px); opacity: 0; }
        to { transform: translateY(0); opacity: 1; }
    }
</style>

<script>
    (function() {
        const modal = document.getElementById('study-alarm-modal');
        const alarmSound = document.getElementById('global-alarm-sound');
        const btnSnooze = document.getElementById('btn-snooze');
        const btnOff = document.getElementById('btn-off');
        
        // Elements to update
        const elSubject = document.getElementById('alarm-subject');
        const elTopic = document.getElementById('alarm-topic');
        const elTime = document.getElementById('alarm-time');

        let currentAlarmType = null; // 'database' or 'manual'
        let currentAlarmData = null; // ID for DB, or Time string for Manual
        const triggeredAlarms = new Set(); // Track triggered alarms in this session

        function checkAlarms() {
            const now = new Date();
            checkDatabaseAlarms(now);
            checkManualAlarm(now);
        }

        function checkDatabaseAlarms(now) {
            fetch('{{ url_for("fetch_scheduled_alarms") }}')
                .then(response => response.json())
                .then(alarms => {
                    const nowMillis = now.getTime();
                    const toleranceMillis = 60000; // 1 minute tolerance

                    for (const alarm of alarms) {
                        const scheduledTime = new Date(alarm.scheduled_datetime);
                        const scheduledMillis = scheduledTime.getTime();
                        
                        // Unique key for this specific alarm instance
                        const alarmKey = `db-${alarm.topic_id}-${scheduledMillis}`;
                        
                        if (scheduledMillis <= nowMillis && 
                            (nowMillis - scheduledMillis) < toleranceMillis &&
                            !triggeredAlarms.has(alarmKey)) 
                        {
                            triggerAlarm('database', alarm, alarmKey);
                            break; // Only trigger one at a time
                        }
                    }
                })
                .catch(error => console.error('Error checking alarms:', error));
        }

        function checkManualAlarm(now) {
            const manualTime = localStorage.getItem('dashboardAlarmTime');
            if (!manualTime) return;

            // Robust time formatting (HH:MM)
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            const currentHHMM = `${hours}:${minutes}`;
            
            // Create a unique key for today's manual alarm (to prevent re-triggering in same minute)
            const todayStr = now.toDateString();
            const alarmKey = `manual-${todayStr}-${manualTime}`;

            if (currentHHMM === manualTime && !triggeredAlarms.has(alarmKey)) {
                triggerAlarm('manual', { time: manualTime }, alarmKey);
            }
        }

        function triggerAlarm(type, data, alarmKey) {
            // If modal is already open, don't override it immediately
            if (modal.style.display === 'flex') return;

            triggeredAlarms.add(alarmKey);
            currentAlarmType = type;
            currentAlarmData = data;

            const titleEl = document.querySelector('.alarm-title');
            const iconEl = document.querySelector('.alarm-icon');

            if (type === 'database') {
                // SCHEDULE ALARM (From Database/Topics)
                titleEl.textContent = "üìÖ Schedule Alarm";
                iconEl.textContent = "üìÖ";
                elSubject.textContent = data.subject_name;
                elTopic.textContent = data.topic_name;
                
                const dateObj = new Date(data.scheduled_datetime);
                elTime.textContent = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            } else {
                // DASHBOARD ALARM (Manual Personal Alarm)
                titleEl.textContent = "‚è∞ Dashboard Alarm";
                iconEl.textContent = "‚è∞";
                elSubject.textContent = "Personal Reminder";
                elTopic.textContent = "Manual Alarm Set";
                
                // Convert 24h string to 12h for display
                const [hours, minutes] = data.time.split(':');
                const dateObj = new Date();
                dateObj.setHours(hours);
                dateObj.setMinutes(minutes);
                elTime.textContent = dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }

            // Show Modal & Play Sound
            modal.style.display = 'flex';
            alarmSound.currentTime = 0;
            alarmSound.play().catch(e => console.log("Audio play failed (user interaction needed):", e));
        }

        function stopAlarm() {
            modal.style.display = 'none';
            alarmSound.pause();
            alarmSound.currentTime = 0;
        }

        // Snooze Handler
        btnSnooze.addEventListener('click', function() {
            if (currentAlarmType === 'database') {
                fetch(`/snooze_alarm/${currentAlarmData.topic_id}`, { method: 'POST' })
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) console.log("DB Alarm snoozed.");
                    });
            } else if (currentAlarmType === 'manual') {
                // Snooze Manual Alarm by 5 minutes
                const [hours, minutes] = currentAlarmData.time.split(':').map(Number);
                const dateObj = new Date();
                dateObj.setHours(hours);
                dateObj.setMinutes(minutes + 5);
                
                const newTime = dateObj.toLocaleTimeString('en-GB', { hour: '2-digit', minute: '2-digit' });
                localStorage.setItem('dashboardAlarmTime', newTime);
                console.log(`Manual Alarm snoozed to ${newTime}`);
                
                // Optional: Notify user on dashboard if they are there (via storage event or reload)
                // But since dashboard polls localStorage, it should update automatically if we implemented it right.
            }
            stopAlarm();
        });

        // Off Handler
        btnOff.addEventListener('click', function() {
            if (currentAlarmType === 'manual') {
                localStorage.removeItem('dashboardAlarmTime');
                console.log("Manual Alarm turned off.");
            }
            // For DB alarms, doing nothing is fine (it won't trigger again as time passes)
            stopAlarm();
        });

        // Check every 5 seconds (more frequent to catch the minute change accurately)
        setInterval(checkAlarms, 5000);
        
        // Initial check
        checkAlarms();
    })();
</script>